name: Upload to Itch.io

on:
  workflow_call:
    inputs:
      buildVersionFull:
        required: true
        type: string
      buildPath:
        required: true
        type: string
      itchioChannel:
        required: true
        type: string
    secrets:
      ITCHIO_API_KEY:
        required: true

jobs:
  upload:
    name: Upload to Itchio
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: ðŸ’¾ Cache Butler
        id: cache-butler
        uses: actions/cache@v4
        with:
          path: ~/.local/bin/butler
          key: butler-linux-amd64-v17  # cambia el sufijo si actualizas la version

      - name: Install butler if not cached
        if: steps.cache-butler.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”½ Descargando Butler..."
          mkdir -p "$HOME/.local/bin"
          curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
          unzip butler.zip
          mv butler "$HOME/.local/bin/butler"
          chmod +x "$HOME/.local/bin/butler"
          echo "âœ… Butler instalado correctamente"
          butler -V

      - name: ðŸ§¾ Verify Butler
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          butler -V
          echo "âœ… Butler disponible en el PATH"

      - name: ðŸ“¦ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: Build-${{ inputs.buildVersionFull }}
          path: ${{ inputs.buildPath }}

      - name: Push to Itch.io
        id: push
        shell: bash
        env:
          BUTLER_API_KEY: ${{ secrets.ITCHIO_API_KEY }}
        run: |
          CHANNEL="${{ inputs.itchioChannel }}"
          BUILD_PATH="${{ inputs.buildPath }}"

          echo "ðŸ—‚ï¸ Verificando carpeta: $BUILD_PATH"
          if [ ! -d "$BUILD_PATH" ]; then
            echo "âŒ Error: No se encontrÃ³ la carpeta de build: $BUILD_PATH"
            exit 1
          fi

          echo "ðŸ“ Carpeta detectada: $BUILD_PATH"
          echo "ðŸŽ¯ Canal destino: $CHANNEL"
          echo "ðŸ“¦ TamaÃ±o aproximado:"
          du -sh "$BUILD_PATH" || true

          echo "â±ï¸ Iniciando subida..."
          START_TIME=$(date +%s)

          butler push "$BUILD_PATH" "$CHANNEL" --userversion "${{ inputs.buildVersionFull }}" || {
            echo "âŒ Fallo durante la subida a Itch.io"
            exit 2
          }

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo "âœ… Subida completada correctamente en ${DURATION}s"
          echo "itchio_url=https://$(echo $CHANNEL | sed 's/:/\//g')" >> $GITHUB_OUTPUT
          echo "upload_duration=${DURATION}s" >> $GITHUB_OUTPUT

      - name: ðŸ§¾ Resumen de subida
        if: always()
        run: |
          {
            echo "## ðŸ“¤ Itch.io Upload Summary"
            echo "**Canal:** ${{ inputs.itchioChannel }}"
            echo "**VersiÃ³n:** ${{ inputs.buildVersionFull || 'N/A' }}"
            echo "**DuraciÃ³n:** ${{ steps.push.outputs.upload_duration }}"
            echo "**URL:** [Abrir en Itch.io](${{ steps.push.outputs.itchio_url }})"
            echo "**Fecha:** $(date '+%Y-%m-%d %H:%M:%S')"
          } >> $GITHUB_STEP_SUMMARY

