name: Build Unity Project

on:
  workflow_call:
    inputs:
      unityVersion:
        required: false
        type: string
        default: 6000.2.10f1
        description: 'Unity version to use for the build'

      buildTarget:
        required: true
        type: string
        description: 'Build target platform (e.g., WebGL, StandaloneWindows64) '

      projectPath:
        required: false
        default: .
        type: string
        description: 'Path to the Unity project'

      publishToItch:
        required: false
        default: false
        type: boolean
        description: 'Whether to publish the build to Itch.io'

      itchioChannel:
        required: false
        default: pax16/test-devops:webgl
        type: string
        description: 'Itch.io channel to publish the build to'

      sendToDiscord:
        required: false
        default: false
        type: boolean
        description: 'Whether to send a notification to Discord'

    secrets:
      UNITY_LICENSE:
        required: true
      UNITY_EMAIL:
        required: true
      UNITY_PASSWORD:
        required: true
      DISCORD_WEBHOOK_URL:
        required: false
      ITCHIO_API_KEY:
        required: false

jobs:
  validate-secrets:
    name: Validate required secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check if secrets are set
        run: |
          missing_secrets=()
          if [ -z "${{ secrets.UNITY_EMAIL }}" ]; then
            missing_secrets+=("EMAIL")
          fi
          if [ -z "${{ secrets.UNITY_PASSWORD }}" ]; then
            missing_secrets+=("PASSWORD")
          fi
          if [ -z "${{ secrets.UNITY_LICENSE }}" ]; then
            missing_secrets+=("LICENSE")
          fi
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            missing_secrets+=("DISCORD_WEBHOOK_URL")
          fi

          if [ ${#missing_secrets[@]} -ne 0 ]; then
            echo "Error: The following secrets are not set: ${missing_secrets[@]} âŒ."
            exit 1
          fi

          if [ -z "${{ vars.PROJECT_NAME }}" ]; then
            echo "Error: PROJECT_NAME variable is not set âŒ."
            echo "PROJECT_NAME=${{ github.event.repository.name }}" >> $GITHUB_ENV
            echo "Setting PROJECT_NAME to ${{ vars.PROJECT_NAME }}"
          fi

          echo "âœ… OK - All set."

  free-disk-space:
    name: Free space disk on Ubuntu
    runs-on: ubuntu-latest
    needs: validate-secrets
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

  build:
    name: Build ${{ inputs.buildTarget }}
    runs-on: ubuntu-latest
    env:
      UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
      UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
      UNITY_VERSION: ${{ vars.UNITY_VERSION }}
    needs: [validate-secrets, free-disk-space]
    outputs:
      build_version_full: ${{ steps.versioning.outputs.buildVersionFull }}
      link_action: ${{ steps.set-vars.outputs.link_action }}
      status: ${{ steps.set-vars.outputs.status }}
      color: ${{ steps.set-vars.outputs.color }}
      build_size: ${{ steps.build-size.outputs.build_size }}
      duration: ${{ steps.duration.outputs.duration }}
      thumbnail_url: ${{ steps.set-vars.outputs.thumbnail_url }}
      timestamp: ${{ steps.set-vars.outputs.timestamp }}

    steps:
      - name: ðŸ•’ Set current date as env variable
        run: |
          START_TIME=$(date -u +%s)
          DATETIME_NOW=$(date +'%Y%m%d')

          echo "START_TIME=$START_TIME" >> $GITHUB_ENV
          echo "DATETIME_NOW=$DATETIME_NOW" >> $GITHUB_ENV

          echo "âœ… Start time set to $START_TIME"
          echo "âœ… Date now set to $DATETIME_NOW"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: |
            Library
            Temp
          key: Library-${{ inputs.buildTarget }}
          restore-keys: Library-

      # Esto lee bundleVersion: 1.0 y guarda 1.0 en BASE_VERSION.
      - name: Read Application.version from ProjectSettings
        id: read-version
        run: |
          BASE_VERSION=$(grep bundleVersion ProjectSettings/ProjectSettings.asset | awk '{print $2}')
          echo "BASE_VERSION=$BASE_VERSION" >> $GITHUB_ENV
          echo "âœ… Base Version: $BASE_VERSION"
           
      - name: Set custom build version
        id: versioning
        run: |
          BRANCH="${{ github.ref_name }}"
          PROJECT_NAME="${{ vars.PROJECT_NAME }}"
          BUILD_TARGET="${{ inputs.buildTarget }}"
          DATETIME_NOW=$(date +'%Y%m%d')

          if [[ "$BRANCH" == "DESARROLLO" ]]; then
            BUILD_VERSION="${BASE_VERSION}-DES"
          elif [[ "$BRANCH" == "PRE_PRODUCCION" ]]; then
            BUILD_VERSION="${BASE_VERSION}-PRE"
          elif [[ "$BRANCH" == "PRODUCCION" ]]; then
            BUILD_VERSION="${BASE_VERSION}-PRO"
          else
            BUILD_VERSION="${BASE_VERSION}-??"
          fi

          echo "BUILD_VERSION=$BUILD_VERSION" >> $GITHUB_ENV
          echo "buildVersion=$BUILD_VERSION" >> $GITHUB_OUTPUT

          BUILD_VERSION_FULL="${PROJECT_NAME}-${BUILD_TARGET}-v${BUILD_VERSION}-${DATETIME_NOW}"
          echo "BUILD_VERSION_FULL=$BUILD_VERSION_FULL" >> $GITHUB_ENV
          echo "buildVersionFull=$BUILD_VERSION_FULL" >> $GITHUB_OUTPUT

          echo "âœ… Build version generada: $BUILD_VERSION_FULL"

      - name: Select Unity Docker image
        id: select-image
        run: |
          UNITY_VERSION="${{ inputs.unityVersion }}"
          BUILD_TARGET="${{ inputs.buildTarget }}"

          case "$BUILD_TARGET" in
            WebGL) IMAGE="ubuntu-2023.1.8f1-webgl-1.1.2" ;;
            StandaloneWindows64) IMAGE="unityci/editor:ubuntu-${UNITY_VERSION}-windows-mono-1" ;;
            Android) IMAGE="unityci/editor:ubuntu-${UNITY_VERSION}-android-1" ;;
            *) IMAGE="unityci/editor:ubuntu-${UNITY_VERSION}-base-1" ;;
          esac

          echo "CUSTOM_IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "custom_image=$IMAGE" >> $GITHUB_OUTPUT
          echo "ðŸ§© Selected image: $IMAGE"

      - name: ðŸ§¹ Prepare Docker environment
        run: |
          echo "ðŸ“¦ Docker space before:"
          docker system df || true
          echo ""
          echo "ðŸ§¹ Cleaning unused Docker data..."
          docker system prune -af || true
          echo ""
          echo "ðŸ“¦ Docker space after cleanup:"
          docker system df || true
          echo ""
          echo "ðŸ”½ Pulling Unity image: $CUSTOM_IMAGE"
          if ! docker pull "$CUSTOM_IMAGE"; then
            echo "âš ï¸ Imagen $CUSTOM_IMAGE no encontrada, usando variante -3"
            FALLBACK_IMAGE="${CUSTOM_IMAGE%-1}-3"
            docker pull "$FALLBACK_IMAGE"
            echo "CUSTOM_IMAGE=$FALLBACK_IMAGE" >> $GITHUB_ENV
          fi
          echo ""
          echo "ðŸ“Š Espacio disponible despuÃ©s del pull:"
          df -h /
          echo "âœ… Imagen lista."

      - name: Build with GameCI
        uses: game-ci/unity-builder@v4
        id: unityBuild
        with:
          targetPlatform: ${{ inputs.buildTarget }}
          unityVersion: ${{ inputs.unityVersion }}
          projectPath: ${{ inputs.projectPath }}
          versioning: Custom
          version: ${{ env.BUILD_VERSION }}
          buildName: ${{ vars.PROJECT_NAME }}
          customImage: ${{ env.CUSTOM_IMAGE }}
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

      - name: Calculate Build Size
        id: build-size
        run: |
          BUILD_PATH="build/${{ inputs.buildTarget }}"
          if [ -d $BUILD_PATH ]; then
            echo "ðŸ“¦ Calculando tamaÃ±o de la build en: $BUILD_PATH"
            SIZE=$(du -sm $BUILD_PATH | cut -f1)
            echo "BUILD_SIZE=$SIZE" >> $GITHUB_ENV
          else
            echo "BUILD_SIZE=N/A" >> $GITHUB_ENV
          fi
          echo "build_size=$SIZE MB" >> $GITHUB_OUTPUT
          echo "âœ… TamaÃ±o de la build: $SIZE"

      # Upload Build
      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ env.BUILD_VERSION_FULL }}
          path: build/${{ inputs.buildTarget }}
          if-no-files-found: "warn"

      - name: Get Artifact ID
        id: get-artifact-id
        run: |
          artifacts=$(curl -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts")

          artifact_id=$(echo "$artifacts" | jq '.artifacts[0].id')
          echo "Artifact ID: $artifact_id"
          echo "artifact_id=$artifact_id" >> $GITHUB_OUTPUT

      - name: â±ï¸ Calculate Build Duration
        if: always()
        id: duration
        run: |
          echo "Workflow started at: ${{ env.START_TIME }}"
          start_time=${{ env.START_TIME }}
          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo "Start time (epoch): $start_time"
          echo "End time (epoch): $end_time"
          echo "Duration (seconds): $duration"

          hours=$((duration / 3600))
          minutes=$(((duration % 3600) / 60))
          seconds=$((duration % 60))
          formatted_duration=$(printf "%02d:%02d:%02d" $hours $minutes $seconds)

          echo "formatted_duration=$formatted_duration" >> $GITHUB_ENV
          echo "duration=$formatted_duration" >> $GITHUB_OUTPUT
          echo "Total time: $formatted_duration"

      - name: Set variables
        if: always()
        id: set-vars
        run: |
          # Variables comunes
          BUILD_TARGET="${{ inputs.buildTarget }}"
          BRANCH="${{ github.ref_name }}"
          BUILD_VERSION="${{ env.BUILD_VERSION }}"
          ARTIFACT_ID="${{ steps.get-artifact-id.outputs.artifact_id }}"
          REPO_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts/${ARTIFACT_ID}"
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Condicional por estado del job
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_MSG="âœ… La build **${BUILD_TARGET}** v${BUILD_VERSION} para la rama **${BRANCH}** se ha completado con Ã©xito."
            STATUS_CODE="OK"
            COLOR=3066993
            THUMBNAIL="https://e7.pngegg.com/pngimages/223/663/png-clipart-green-check-illustration-check-mark-checkbox-yes-miscellaneous-angle.png"
          else
            STATUS_MSG="âŒ La build **${BUILD_TARGET}** v${BUILD_VERSION} para la rama **${BRANCH}** ha fallado."
            STATUS_CODE="FAIL"
            COLOR=15158332
            THUMBNAIL="https://e1.pngegg.com/pngimages/720/726/png-clipart-emoji-sticker-x-icon.png"
          fi

          # Exportar a entorno global (GITHUB_ENV)
          {
            echo "STATUS=${STATUS_MSG}"
            echo "STATUS_CODE=${STATUS_CODE}"
            echo "COLOR=${COLOR}"
            echo "THUMBNAIL_URL=${THUMBNAIL}"
            echo "LINK_ACTION=${REPO_URL}"
            echo "TIMESTAMP=${TIMESTAMP}"
          } >> $GITHUB_ENV

          # Exportar a outputs (para otros workflows)
          {
            echo "status=${STATUS_MSG}"
            echo "status_code=${STATUS_CODE}"
            echo "color=${COLOR}"
            echo "thumbnail_url=${THUMBNAIL}"
            echo "link_action=${REPO_URL}"
            echo "timestamp=${TIMESTAMP}"
          } >> $GITHUB_OUTPUT

          echo "âœ… Variables de estado establecidas correctamente:"
          echo "  - STATUS_CODE: $STATUS_CODE"
          echo "  - LINK_ACTION: $REPO_URL"
          echo "  - TIMESTAMP: $TIMESTAMP"

      - name: Generate build metrics JSON
        if: always()
        run: |
          mkdir -p metrics
          cat <<EOF > metrics/build-metrics.json
          {
            "project": "${{ vars.PROJECT_NAME }}",
            "version": "${{ env.BUILD_VERSION }}",
            "platform": "${{ inputs.buildTarget }}",
            "branch": "${{ github.ref_name }}",
            "status": "${{ env.STATUS_CODE }}",
            "build_size": "${{ env.BUILD_SIZE }}",
            "duration": "${{ env.formatted_duration }}",
            "author": "$(git log -1 --pretty=format:'%an')",
            "date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Upload build metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ env.BUILD_VERSION_FULL }}
          path: metrics/build-metrics.json

      - name: Publish build summary
        if: always()
        run: |
          {
            echo "## ðŸ› ï¸ Build Summary - **${{ steps.versioning.outputs.buildVersionFull }}**"
            echo "- Plataforma: **${{ inputs.buildTarget }}**"
            echo "- Rama: **${{ github.ref_name }}**"
            echo "- TamaÃ±o de la build: **${{ steps.build-size.outputs.build_size }}**"
            echo "- DuraciÃ³n: `${{ steps.duration.outputs.duration || 'N/A' }}`"
            echo "- Status Code: ${{ env.STATUS_CODE }}"
            echo "- Resultado: ${{ env.STATUS }}"

            if [ "${{ job.status }}" != "success" ]; then
              echo "- â— La compilacion ha fallado antes de completar el artefacto."
            fi

            if [ "${{ steps.build-size.outputs.build_size }}" != "N/A" ]; then
              echo "- [ðŸ”— Descargar artifact](${{ steps.set-vars.outputs.link_action }})"
            fi

            echo "- Fecha: $(date '+%Y-%m-%d %H:%M:%S')"
          } >> $GITHUB_STEP_SUMMARY

      - name: Show commit changes in summary
        if: always()
        run: |
          {
            TARGET_BRANCH="${{ github.ref_name }}"
            if [ "$TARGET_BRANCH" = "PRE_PRODUCCION" ]; then
              SOURCE_BRANCH="DESARROLLO"
            elif [ "$TARGET_BRANCH" = "PRODUCCION" ]; then
              SOURCE_BRANCH="PRE_PRODUCCION"
            else
              echo "âš ï¸ Rama actual no reconocida ($TARGET_BRANCH), usando DESARROLLO como origen."
              SOURCE_BRANCH="DESARROLLO"
            fi
          
            echo "## ðŸ“¦ Cambios incluidos en el MERGE de $SOURCE_BRANCH â†’ $TARGET_BRANCH"
            
            # Si las ramas son iguales, no hay promociÃ³n
            if [ "$SOURCE_BRANCH" = "$TARGET_BRANCH" ]; then
              echo "â„¹ï¸ **Ramas idÃ©nticas:** $SOURCE_BRANCH â†’ $TARGET_BRANCH"
              echo ""
              echo "No se ha detectado una promociÃ³n entre ramas diferentes, por lo que no se listan commits ni archivos modificados."
              echo ""
              echo "**Fecha de generaciÃ³n:** $(date '+%Y-%m-%d %H:%M:%S')"
              exit 0
            fi

            # Buscar el commit base comÃºn
            MERGE_BASE=$(git merge-base $SOURCE_BRANCH $TARGET_BRANCH)
            echo "**Rango de commits:** ${MERGE_BASE:0:7}..$(git rev-parse --short $SOURCE_BRANCH)"
            echo ""

            # Mostrar commits nuevos (sin merges)
            echo "**Commits incluidos:**"
            echo "\`\`\`"
            git log $MERGE_BASE..$SOURCE_BRANCH --pretty=format:"%h - %s (%an)" --no-merges || echo "(Sin commits detectados)"
            echo "\`\`\`"
            echo ""

            # Mostrar archivos modificados
            echo "**Archivos modificados (mÃ¡x 15):**"
            echo "\`\`\`"
            git diff --name-only $MERGE_BASE $SOURCE_BRANCH | head -n 15 || echo "(No hay archivos detectados)"
            echo "\`\`\`"

            COUNT=$(git log $MERGE_BASE..$SOURCE_BRANCH --oneline --no-merges | wc -l)
            echo ""
            echo "**Total de commits:** $COUNT"

            echo ""
            echo "**Fecha de generaciÃ³n:** $(date '+%Y-%m-%d %H:%M:%S')"
          } >> $GITHUB_STEP_SUMMARY

  upload-to-itchio:
    if: ${{ inputs.publishToItch == true }}
    needs: build
    uses: ./.github/workflows/upload-itchio.yml
    with:
      buildVersionFull: ${{ needs.build.outputs.build_version_full }}
      buildPath: build/${{ inputs.buildTarget }}
      itchioChannel: ${{ inputs.itchioChannel }}
    secrets:
      ITCHIO_API_KEY: ${{ secrets.ITCHIO_API_KEY }}

  notify-discord:
    if: ${{ inputs.sendToDiscord == true }}
    needs: build
    uses: ./.github/workflows/notify-discord.yml
    with:
      build_version: ${{ needs.build.outputs.build_version_full }}
      link_action: ${{ needs.build.outputs.link_action }}
      status: ${{ needs.build.outputs.status }}
      color: ${{ needs.build.outputs.color }}
      branch_name: ${{ github.ref_name }}
      build_platform: ${{ inputs.buildTarget }}
      build_size: ${{ needs.build.outputs.build_size }}
      duration: ${{ needs.build.outputs.duration }}
      project_name: ${{ vars.PROJECT_NAME }}
      thumbnail_url: ${{ needs.build.outputs.thumbnail_url }}
      timestamp: ${{ needs.build.outputs.timestamp }}
    secrets:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
